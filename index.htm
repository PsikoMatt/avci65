<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AvcÄ± v9.1 - AkÄ±llÄ± Ä°skan</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #f59e0b; --red: #ef4444; --blue: #38bdf8; --text: #f1f5f9; --green: #22c55e; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: none; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* ÃœST PANEL */
        #top-bar { width: 100%; background: #000; padding: 15px; display: flex; justify-content: center; gap: 30px; border-bottom: 3px solid var(--accent); position: sticky; top:0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .res { font-weight: bold; font-size: 1.1em; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        
        #noti-trigger { position: relative; cursor: pointer; font-size: 1.5em; transition: 0.3s; }
        #noti-dot { position: absolute; top: -5px; right: -5px; background: var(--red); width: 12px; height: 12px; border-radius: 50%; display: none; border: 2px solid #000; }

        #noti-panel { position: fixed; right: -320px; top: 70px; width: 300px; height: 550px; background: var(--card); border-left: 3px solid var(--accent); transition: 0.4s; z-index: 999; display: flex; flex-direction: column; box-shadow: -10px 0 20px rgba(0,0,0,0.5); }
        #noti-panel.open { right: 0; }
        #noti-header { padding: 12px; background: #000; font-weight: bold; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }

        /* ÅEHÄ°R GRID VE BÄ°NA GÃ–RSELLERÄ° */
        .grid { display: grid; grid-template-columns: repeat(4, 180px); gap: 20px; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 20px; }
        .slot { 
            background: var(--card); border: 2px solid #334155; border-radius: 16px; height: 170px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; text-align: center; transition: 0.3s; position: relative; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .slot:hover { border-color: var(--accent); transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.4); }
        .slot.building { border-color: var(--accent); background: repeating-linear-gradient(45deg, #1e293b, #1e293b 10px, #26334a 10px, #26334a 20px); }
        
        /* BÄ°NA Ã–ZEL RENKLERÄ° */
        .slot.AltÄ±n.Madeni { background: linear-gradient(135deg, #1e293b 0%, #3d2b01 100%); border-color: #b45309; }
        .slot.AvcÄ±.OcaÄŸÄ± { background: linear-gradient(135deg, #1e293b 0%, #450a0a 100%); border-color: #991b1b; }
        .slot.GÃ¶zcÃ¼.Kulesi { background: linear-gradient(135deg, #1e293b 0%, #0c4a6e 100%); border-color: #0369a1; }
        .slot.Ãœniversite { background: linear-gradient(135deg, #1e293b 0%, #14532d 100%); border-color: #15803d; }
        .slot.Merkez.KÃ¶ÅŸk { background: linear-gradient(135deg, #1e293b 0%, #4c1d95 100%); border-color: #6d28d9; }
        .slot.Hazine.OdasÄ± { background: linear-gradient(135deg, #1e293b 0%, #3f3f46 100%); border-color: #52525b; }

        .b-icon { font-size: 3em; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .b-lvl { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 10px; font-size: 0.7em; border: 1px solid rgba(255,255,255,0.2); }

        /* AVCI OCAÄI SLIDER */
        .slider-container { margin: 15px 0; padding: 20px; background: #0f172a; border-radius: 12px; border: 1px solid #334155; width: 90%; margin-left: auto; margin-right: auto; }
        .input-group { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
        input[type=range] { width: 100% !important; cursor: pointer; accent-color: var(--blue); height: 10px; border-radius: 5px; }
        input[type=number] { background: #1e293b; color: var(--blue); border: 1px solid var(--blue); border-radius: 8px; padding: 8px; width: 100px; text-align: center; font-size: 1.2em; font-weight: bold; outline: none; }

        /* HARÄ°TA CSS */
        #map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; background: #020617; border-radius: 15px; border: 2px solid var(--accent); margin-top: 20px; box-shadow: inset 0 0 20px #000; }
        .map-zone { background: #1e293b; border: 1px solid #475569; padding: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; border-radius: 10px; position: relative; }
        .parcel { width: 45px; height: 45px; background: #0f172a; border: 1px dashed #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; color: #475569; transition: 0.3s; cursor: pointer; }
        .parcel.occupied { background: var(--blue); border: 2px solid var(--accent); color: white; box-shadow: 0 0 10px var(--blue); }
        .parcel.enemy { background: var(--red); border: 2px solid white; color: white; box-shadow: 0 0 15px var(--red); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal { background: var(--card); padding: 30px; border-radius: 20px; border: 2px solid var(--accent); width: 450px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        
        button { background: var(--accent); border: none; padding: 12px; margin: 8px 0; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; color: #000; box-shadow: 0 3px 0 #b45309; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 0 #b45309; }
        button:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 0 #b45309; }
        button:disabled { background: #475569 !important; opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        
        .timer-val { font-size: 2.5em; font-weight: bold; color: var(--accent); margin: 10px 0; font-family: monospace; letter-spacing: 2px; }
        #cap-bar { height: 100%; background: linear-gradient(90deg, var(--green), #4ade80); width: 0%; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="res" style="color: gold; display:flex; flex-direction:column; align-items:center;">
            <span>ğŸ’° <span id="gold">0</span> / <span id="max-gold">2000</span></span>
            <div id="cap-container" style="width:120px; height:8px; background:#333; border-radius:4px; margin-top:5px; overflow:hidden;"><div id="cap-bar"></div></div>
        </div>
        <div class="res" style="color: var(--blue);">ğŸ¹ <span id="h-points">0</span></div>
        <div class="res" style="color: var(--red);">âš”ï¸ <span id="h-power">0</span></div>
        <div id="noti-trigger" onclick="toggleNotifications()">ğŸ”” <div id="noti-dot"></div></div>
    </div>

    <div id="noti-panel">
        <div id="noti-header">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span id="p-label" style="font-size:0.9em; color:var(--blue);">HÃœKÃœMDAR: ---</span>
                <span onclick="resetLocal()" style="cursor:pointer; color:var(--red); font-size:0.7em; border:1px solid var(--red); padding:3px; border-radius:4px;">[SIFIRLA]</span>
            </div>
            <button id="admin-reset" onclick="resetGlobal()" class="hidden" style="background:var(--red); color:white; font-size:0.65em; padding:8px; margin-top:5px;">âš ï¸ DATABASE'Ä° SIFIRLA (ADMÄ°N)</button>
        </div>
        <div id="noti-content" style="flex:1; overflow-y:auto; padding:10px;"></div>
    </div>

    <div style="margin-top: 25px; display:flex; gap:10px;">
        <button onclick="showView('city')" style="width: 140px; background:#334155; color:white;">ğŸ° Åehrim</button>
        <button onclick="showView('world')" style="width: 140px; background:#334155; color:white;">ğŸŒ Harita</button>
    </div>

    <div id="city-view" class="view-container"><div class="grid" id="city-grid"></div></div>
    <div id="world-view" class="view-container hidden" style="text-align: center;">
        <h3 style="margin-top: 25px; color:var(--blue);">ğŸŒ ONLINE DÃœNYA HARÄ°TASI</h3>
        <p style="font-size: 0.85em; color: #94a3b8; margin-bottom:20px;">AkÄ±llÄ± iskan protokolÃ¼ ile Ã§akÄ±ÅŸmalar engellendi.</p>
        <div id="map-container"></div>
    </div>

    <div id="modal-overlay" class="overlay"><div id="modal-content" class="modal"></div></div>

    <script>
        // --- GÃœVENLÄ°K ---
        const ACCESS_PASSWORD = "adem65";
        const inputPass = prompt("KrallÄ±k GiriÅŸ Åifresi:");
        if (inputPass !== ACCESS_PASSWORD) {
            alert("HatalÄ± Åifre!");
            document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:100px;'>YETKÄ°SÄ°Z ERÄ°ÅÄ°M</h1>";
        } else {
            document.body.style.display = "flex";
        }

        const firebaseConfig = {
            apiKey: "AIzaSyArv5Fbrvmx377ZbnXmsY4iSy_zSrwOEHk",
            authDomain: "avci65-5dc76.firebaseapp.com",
            projectId: "avci65-5dc76",
            storageBucket: "avci65-5dc76.firebasestorage.app",
            messagingSenderId: "477611425105",
            appId: "1:477611425105:web:a2393513604a4f73b2e770",
            measurementId: "G-MSG4ZHDDFN",
            databaseURL: "https://avci65-5dc76-default-rtdb.europe-west1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let playerName = localStorage.getItem('avci_name') || prompt("KrallÄ±k Ä°sminiz (BaÅŸkalarÄ±yla aynÄ± isim girmeyin):", "Adem");
        localStorage.setItem('avci_name', playerName);
        document.getElementById('p-label').innerText = "HÃœKÃœMDAR: " + playerName;
        if(playerName === "Adem") document.getElementById('admin-reset').classList.remove('hidden');

        const defaultState = {
            gold: 1000, hPoints: 0, hPower: 0,
            slots: Array(8).fill(null).map(() => ({ type: 'BoÅŸ Slot', level: 0, status: 'empty', timer: 0 })),
            techs: { mining: 0, hunting: 0, engineering: 0 },
            activeExpedition: null, activeConversion: null, activeRaid: null,
            npcCD: { "VahÅŸi Kurt": 0, "Gezgin Haydut": 0, "KÄ±zgÄ±n AyÄ±": 0, "Kara Ejderha": 0 },
            cities: [] // init iÃ§erisinde akÄ±llÄ± iskan ile doldurulacak
        };

        let state = defaultState;
        let activeSlotIndex = -1;
        let allPlayers = {};
        let isLoaded = false;

        const BUILDINGS = {
            'AltÄ±n Madeni': { cost: 50, icon: 'â›ï¸', effect: (l) => (l * 5).toFixed(1), label: "Gelir (Sn)" },
            'AvcÄ± OcaÄŸÄ±': { cost: 80, icon: 'ğŸ¹', effect: (l) => "Hassas", label: "DÃ¶nÃ¼ÅŸÃ¼m" },
            'Ãœniversite': { cost: 150, icon: 'ğŸ“œ', effect: (l) => l, label: "ArÅŸ. Seviyesi" },
            'Hazine OdasÄ±': { cost: 100, icon: 'ğŸ“¦', effect: (l) => l * 5000, label: "Kapasite" },
            'GÃ¶zcÃ¼ Kulesi': { cost: 70, icon: 'ğŸ”­', effect: (l) => l, label: "Menzil" },
            'Pazar Yeri': { cost: 120, icon: 'âš–ï¸', label: "Takas" },
            'HÄ±zlandÄ±rÄ±cÄ±': { cost: 200, icon: 'âš¡', label: "HÄ±z" },
            'Merkez KÃ¶ÅŸk': { cost: 300, icon: 'ğŸ›ï¸', label: "Åehir HakkÄ±" }
        };

        const NPCS = [
            { name: "VahÅŸi Kurt", power: 5, reward: 250, icon: 'ğŸº', req: 1 },
            { name: "Gezgin Haydut", power: 15, reward: 800, icon: 'ğŸ‘¤', req: 3 },
            { name: "KÄ±zgÄ±n AyÄ±", power: 40, reward: 2000, icon: 'ğŸ»', req: 5 },
            { name: "Kara Ejderha", power: 100, reward: 10000, icon: 'ğŸ‰', req: 10 }
        ];

        // --- AKILLI Ä°SKAN (SMART SETTLEMENT) PROTOKOLÃœ ---
        function getSmartSpawnPoint() {
            let occupied = [];
            for (let name in allPlayers) {
                if (allPlayers[name].state && allPlayers[name].state.cities) {
                    allPlayers[name].state.cities.forEach(c => {
                        occupied.push(`${c.zX},${c.zY},${c.pIdx}`);
                    });
                }
            }
            let emptyPool = [];
            for (let x = 0; x < 5; x++) {
                for (let y = 0; y < 5; y++) {
                    for (let p = 0; p < 4; p++) {
                        if (!occupied.includes(`${x},${y},${p}`)) {
                            emptyPool.push({ zX: x, zY: y, pIdx: p });
                        }
                    }
                }
            }
            if (emptyPool.length > 0) {
                return emptyPool[Math.floor(Math.random() * emptyPool.length)];
            }
            return { zX: Math.floor(Math.random()*5), zY: Math.floor(Math.random()*5), pIdx: Math.floor(Math.random()*4) };
        }

        function isSlotOccupied(x, y, p) {
            for (let name in allPlayers) {
                if (allPlayers[name].state && allPlayers[name].state.cities) {
                    if (allPlayers[name].state.cities.some(c => c.zX == x && c.zY == y && c.pIdx == p)) return true;
                }
            }
            return false;
        }

        function init() { 
            db.ref('players').once('value', (snap) => {
                allPlayers = snap.val() || {};
                db.ref('players/' + playerName).once('value', (userSnap) => {
                    if(userSnap.exists()) {
                        state = userSnap.val().state || defaultState;
                    } else {
                        // Yeni Oyuncu: AkÄ±llÄ± Ä°skan Devreye Girer
                        const initialCity = getSmartSpawnPoint();
                        state = { ...defaultState, cities: [initialCity] };
                        syncCloud();
                        addLog("HoÅŸ geldin HÃ¼kÃ¼mdar! AkÄ±llÄ± iskan ile boÅŸ bir bÃ¶lgeye yerleÅŸtirildin.");
                    }
                    isLoaded = true; renderCity();
                });
            });
            setInterval(gameLoop, 1000); 
            setInterval(syncCloud, 4000); 
            listenPlayers(); 
        }

        function syncCloud() { if(isLoaded) db.ref('players/' + playerName).set({ name: playerName, state: state, lastSeen: Date.now() }); }
        function listenPlayers() { 
            db.ref('players').on('value', (snap) => { 
                allPlayers = snap.val() || {}; 
                if(allPlayers[playerName]?.state) state.hPoints = Math.max(0, allPlayers[playerName].state.hPoints); updateUI();
                if(!document.getElementById('world-view').classList.contains('hidden')) renderMap(); 
            }); 
        }

        function resetLocal() { if(confirm("KrallÄ±ÄŸÄ±nÄ± sÄ±fÄ±rlamak istiyor musun?")) { db.ref('players/' + playerName).remove(); localStorage.clear(); location.reload(); } }
        function resetGlobal() { if(confirm("DATABASE SIFIRLAMA: Herkes silinecek! Devam edilsin mi?")) { db.ref('players').remove(); addLog("DÃ¼nya sÄ±fÄ±rlandÄ±."); } }

        function renderMap() {
            const container = document.getElementById('map-container');
            if(!container) return; container.innerHTML = '';
            for(let y = 0; y < 5; y++) {
                for(let x = 0; x < 5; x++) {
                    const zone = document.createElement('div'); zone.className = 'map-zone';
                    zone.innerHTML = `<div class="zone-label" style="position:absolute; top:-12px; left:5px; background:var(--accent); color:black; font-size:0.6em; padding:1px 4px; border-radius:3px; font-weight:bold;">${x},${y}</div>`;
                    for(let p = 0; p < 4; p++) {
                        const parcel = document.createElement('div'); parcel.className = 'parcel';
                        const isMine = state.cities.find(c => c.zX === x && c.zY === y && c.pIdx === p);
                        let enemyData = null;
                        for(let name in allPlayers) {
                            if(name === playerName) continue;
                            if(allPlayers[name].state?.cities?.find(c => c.zX === x && c.zY === y && c.pIdx === p)) { enemyData = allPlayers[name]; break; }
                        }
                        if(isMine) { parcel.classList.add('occupied'); parcel.innerHTML = 'ğŸ°'; parcel.onclick = () => showView('city'); } 
                        else if(enemyData) { parcel.classList.add('enemy'); parcel.innerHTML = 'ğŸ°'; parcel.onclick = () => showRaidModal(enemyData); } 
                        else { parcel.innerText = 'BOÅ'; parcel.onclick = () => showMapActions(x, y, p); }
                        zone.appendChild(parcel);
                    }
                    container.appendChild(zone);
                }
            }
        }

        function showRaidModal(enemy) {
            const modal = document.getElementById('modal-content');
            if(state.activeRaid) {
                modal.innerHTML = `<h3>âš”ï¸ ORDULAR YOLDA</h3><div class="stats-box"><div class="timer-val" id="modal-timer">${Math.max(0, state.activeRaid.timer)}s</div></div><button onclick="closeModal()">KAPAT</button>`;
            } else {
                modal.innerHTML = `<h3>âš”ï¸ BASKIN: ${enemy.name}</h3><div class="stats-box"><div class="stat-line"><span>Rakip GÃ¼cÃ¼:</span> <b style="color:var(--red);">${enemy.state.hPower}</b></div><div class="stat-line"><span>Senin GÃ¼cÃ¼n:</span> <b style="color:var(--blue);">${state.hPower}</b></div></div><button onclick="startRaid('${enemy.name}')" style="background:var(--red); color:white;">BASKIN BAÅLAT (5sn)</button><button onclick="closeModal()" style="background:#444; color:white; margin-top:10px;">GERÄ° Ã‡EKÄ°L</button>`;
            }
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function startRaid(tName) { state.activeRaid = { timer: 5, target: tName }; addLog(`${tName} krallÄ±ÄŸÄ±na ordu gÃ¶nderildi!`); showRaidModal(allPlayers[tName]); }

        function executeRaidResult() {
            const target = allPlayers[state.activeRaid.target];
            if(target && state.hPower > target.state.hPower) {
                const stolen = Math.floor(target.state.hPoints * 0.2);
                state.hPoints += stolen;
                db.ref('players/' + state.activeRaid.target + '/state/hPoints').set(Math.max(0, target.state.hPoints - stolen));
                addLog(`Zafer! ${state.activeRaid.target} krallÄ±ÄŸÄ±ndan ${stolen} puan yaÄŸmalandÄ±.`);
            } else { addLog(`MaÄŸlubiyet! Savunma hattÄ±nÄ± aÅŸamadÄ±n.`); }
            state.activeRaid = null; syncCloud();
        }

        function showMapActions(x, y, p) {
            if(isSlotOccupied(x, y, p)) { addLog("Bu parsel dolu, baÅŸka yer seÃ§!"); return; }
            const modal = document.getElementById('modal-content');
            const mKoshk = state.slots.find(s => s.type === 'Merkez KÃ¶ÅŸk' && s.status === 'complete');
            const rightsLeft = (mKoshk ? mKoshk.level : 0) - (state.cities.length - 1);
            let tOptions = `<h4>ğŸš€ Åehri TaÅŸÄ± (50 AltÄ±n)</h4><div style="display:flex; flex-direction:column; gap:5px; margin-bottom:10px;">`;
            state.cities.forEach((city, idx) => { tOptions += `<button onclick="executeTeleport(${idx}, ${x}, ${y}, ${p})" ${state.gold < 50 ? 'disabled' : ''}>${idx === 0 ? "Ana" : "Koloni " + idx} â¡ buraya</button>`; });
            tOptions += `</div>`;
            modal.innerHTML = `<h3>ğŸŒ Koordinat: ${x},${y} [Parsel ${p}]</h3><div class="stats-box"><div class="stat-line"><span>Ek Åehir HakkÄ±n:</span> <b>${Math.max(0, rightsLeft)}</b></div></div>${tOptions}<h4>ğŸ—ï¸ Kolonizasyon (100 AltÄ±n)</h4><button onclick="executeEstablish(${x}, ${y}, ${p})" ${(state.gold < 100 || rightsLeft <= 0) ? 'disabled' : ''} style="background:var(--green); color:black;">Yeni Åehir Kur</button><button onclick="closeModal()" style="background:#444; color:white; margin-top:10px;">KAPAT</button>`;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function executeTeleport(idx, x, y, p) { if(!isSlotOccupied(x,y,p) && state.gold >= 50) { state.gold -= 50; state.cities[idx] = { zX: x, zY: y, pIdx: p }; closeModal(); renderMap(); updateUI(); syncCloud(); } }
        function executeEstablish(x, y, p) { if(!isSlotOccupied(x,y,p) && state.gold >= 100) { state.gold -= 100; state.cities.push({ zX: x, zY: y, pIdx: p }); closeModal(); renderMap(); updateUI(); syncCloud(); } }

        // --- GÃ–RSEL ÅEHÄ°R VE BÄ°NA SÄ°STEMÄ° (ONAYLI v5.6 PDF) ---
        function renderCity() {
            const container = document.getElementById('city-grid');
            if(!container) return; container.innerHTML = '';
            state.slots.forEach((slot, i) => {
                const div = document.createElement('div');
                const typeClass = slot.type.replace(/\s+/g, '.');
                div.className = `slot ${slot.status} ${typeClass}`;
                div.onclick = () => handleSlot(i);
                const icon = slot.status === 'empty' ? '+' : (BUILDINGS[slot.type]?.icon || 'ğŸ ');
                if(slot.status === 'building') { div.innerHTML = `<div class="b-icon">ğŸ—ï¸</div><strong>Ä°NÅA EDÄ°LÄ°YOR</strong><br>${slot.timer}s`; } 
                else if(slot.type === 'AvcÄ± OcaÄŸÄ±' && state.activeExpedition) { div.innerHTML = `<div class="b-icon">ğŸ¹</div><strong>SEFERDE</strong><br>${state.activeExpedition.timer}s`; } 
                else if(slot.type === 'AvcÄ± OcaÄŸÄ±' && state.activeConversion) { div.innerHTML = `<div class="b-icon">âš”ï¸</div><strong>EÄÄ°TÄ°MDE</strong><br>${state.activeConversion.timer}s`; } 
                else { div.innerHTML = `${slot.level > 0 ? `<div class="b-lvl">Svl ${slot.level}</div>` : ''}<div class="b-icon">${icon}</div><strong style="font-size:0.85em;">${slot.type}</strong>`; }
                container.appendChild(div);
            });
        }

        function handleSlot(i) {
            activeSlotIndex = i; const slot = state.slots[i]; const modal = document.getElementById('modal-content'); modal.innerHTML = '';
            const title = document.createElement('h3'); title.innerText = slot.status === 'empty' ? "ğŸ—ï¸ Yeni Ä°nÅŸaat" : `${BUILDINGS[slot.type].icon} ${slot.type} (Svl ${slot.level})`;
            modal.appendChild(title); const cDiv = document.createElement('div'); modal.appendChild(cDiv);
            if(slot.status === 'building') { cDiv.innerHTML = `<div class="stats-box"><div class="timer-val" id="modal-timer" style="text-align:center;">${slot.timer}s</div></div><button onclick="closeModal()">GERÄ°</button>`; } 
            else if(slot.status === 'empty') { for(let n in BUILDINGS) { if(!state.slots.some(s => s.type === n)) { const b = document.createElement('button'); b.innerHTML = `${BUILDINGS[n].icon} ${n} (${BUILDINGS[n].cost} AltÄ±n)`; b.disabled = state.gold < BUILDINGS[n].cost; b.onclick = () => { startBuild(i, n); closeModal(); renderCity(); }; cDiv.appendChild(b); }}} 
            else { 
                const upC = slot.level * 150; const b = BUILDINGS[slot.type];
                if(slot.type === 'AltÄ±n Madeni') cDiv.innerHTML = `<div class="stats-box"><div class="stat-line"><span>Mevcut Gelir (Sn):</span> <b>${b.effect(slot.level)}</b></div><div class="stat-line"><span>YÃ¼kseltme SonrasÄ±:</span> <b>${b.effect(slot.level+1)}</b></div></div>`;
                else if(slot.type === 'Merkez KÃ¶ÅŸk') cDiv.innerHTML = `<div class="stats-box"><div class="stat-line"><span>Mevcut Åehir HakkÄ±:</span> <b>${slot.level}</b></div><div class="stat-line"><span>YÃ¼kseltme SonrasÄ±:</span> <b>${slot.level+1}</b></div></div>`;
                else if(slot.type === 'Hazine OdasÄ±') cDiv.innerHTML = `<div class="stats-box"><div class="stat-line"><span>Mevcut Kapasite:</span> <b>${slot.level * 5000}</b></div><div class="stat-line"><span>YÃ¼kseltme SonrasÄ±:</span> <b>${(slot.level+1) * 5000}</b></div></div>`;
                else if(slot.type === 'GÃ¶zcÃ¼ Kulesi') return openWatchtowerUI(slot.level, i);
                else if(slot.type === 'Ãœniversite') return openUniversityUI();
                const ub = document.createElement('button'); ub.innerHTML = `YÃ¼kselt (${upC} AltÄ±n)`; ub.disabled = state.gold < upC; ub.onclick = () => { upgrade(i, upC); handleSlot(i); renderCity(); }; cDiv.appendChild(ub); 
                if(slot.type === 'AvcÄ± OcaÄŸÄ±') renderHunterUI(cDiv, slot, i); 
                const db = document.createElement('button'); db.innerText = "BinayÄ± YÄ±k"; db.style.background = "var(--red)"; db.style.color="white"; db.onclick = () => { demolish(i); closeModal(); renderCity(); }; cDiv.appendChild(db); 
            }
            addCloseButton(modal); document.getElementById('modal-overlay').style.display = 'flex';
        }

        function renderHunterUI(cDiv, slot, i) {
            if(state.activeExpedition) { cDiv.innerHTML += `<div class="stats-box"><div class="timer-val" id="modal-timer" style="text-align:center;">${state.activeExpedition.timer}s</div></div>`; const b = document.createElement('button'); b.className = 'btn-cancel'; b.innerText = "Seferi Ä°ptal Et"; b.onclick = () => cancelExpedition(); cDiv.appendChild(b); } 
            else if(state.activeConversion) { cDiv.innerHTML += `<div class="stats-box"><div class="timer-val" id="modal-timer" style="text-align:center;">${state.activeConversion.timer}s</div></div>`; } 
            else { 
                [{t:5,p:250,r:1},{t:10,p:600,r:3},{t:15,p:1000,r:5}].forEach(ex => { const b = document.createElement('button'); b.innerHTML = `${ex.t}s Sefer (${ex.p} Puan)${slot.level < ex.r ? `<br><small>${ex.r}. Svl Gerekl</small>` : ''}`; b.disabled = slot.level < ex.r; b.onclick = () => { startExpedition(ex.t, ex.p); handleSlot(i); renderCity(); }; cDiv.appendChild(b); });
                const sWrap = document.createElement('div'); sWrap.className = 'slider-container'; sWrap.innerHTML = `<div class="input-group"><input type="number" id="pts-in" min="0" max="${state.hPoints}" value="0"></div><input type="range" id="pts-range" min="0" max="${state.hPoints}" value="0">`; cDiv.appendChild(sWrap); const inN = sWrap.querySelector('#pts-in'); const inR = sWrap.querySelector('#pts-range'); inN.oninput = (e) => { let v = Math.max(0, parseInt(e.target.value)||0); if(v>state.hPoints) v=Math.floor(state.hPoints); inN.value=v; inR.value=v; }; inR.oninput = (e) => inN.value = e.target.value;
                const cb = document.createElement('button'); cb.innerText = "PuanÄ± GÃ¼ce Aktar (2sn)"; cb.style.background="var(--blue)"; cb.style.color="white"; cb.onclick = () => { if(parseInt(inN.value) <= state.hPoints) startConversion(parseInt(inN.value)); handleSlot(i); renderCity(); }; cDiv.appendChild(cb); 
            }
        }

        function openWatchtowerUI(lvl, idx) {
            activeSlotIndex = idx; const modal = document.getElementById('modal-content'); modal.innerHTML = `<h3>ğŸ”­ GÃ¶zcÃ¼ Kulesi (Svl ${lvl})</h3><div id="wt-c"></div>`;
            NPCS.forEach(npc => { const box = document.createElement('div'); box.className = 'stats-box'; const cd = state.npcCD[npc.name] || 0; box.innerHTML = `<div class="stat-line"><strong>${npc.icon} ${npc.name}</strong><span>GÃ¼Ã§: ${npc.power}</span></div>`; const btn = document.createElement('button'); btn.setAttribute('data-npc', npc.name); if(lvl < npc.req) { btn.innerHTML = `KÄ°LÄ°TLÄ° <span class="locked-info">${npc.req}. Svl</span>`; btn.disabled = true; } else if(cd > 0) { btn.innerHTML = `Bekleniyor (${cd}s)`; btn.disabled = true; } else { btn.innerText = `SALDIR (+${npc.reward} Puan)`; btn.onclick = () => { attackNPC(npc); }; } box.appendChild(btn); modal.querySelector('#wt-c').appendChild(box); });
            const ub = document.createElement('button'); ub.innerHTML = `Kuleyi YÃ¼kselt (${lvl * 150} AltÄ±n)`; ub.disabled = state.gold < (lvl * 150); ub.onclick = () => { upgrade(idx, lvl * 150); closeModal(); renderCity(); }; modal.appendChild(ub); addCloseButton(modal); document.getElementById('modal-overlay').style.display = 'flex';
        }

        function openUniversityUI() {
            const modal = document.getElementById('modal-content'); modal.innerHTML = `<h3>ğŸ“œ Teknik Laboratuvar</h3><div class="stats-box"><div class="stat-line">ğŸ’° Maden: <span>+%${state.techs.mining * 10}</span><button onclick="research('mining')">GeliÅŸtir</button></div><div class="stat-line">ğŸ¹ Taktik: <span>+%${state.techs.hunting * 20}</span><button onclick="research('hunting')">GeliÅŸtir</button></div><div class="stat-line">ğŸ—ï¸ Lojistik: <span>-%${state.techs.engineering * 5}</span><button onclick="research('engineering')">GeliÅŸtir</button></div></div>`; addCloseButton(modal); document.getElementById('modal-overlay').style.display = 'flex';
        }

        // --- GAME LOOP ---
        function gameLoop() {
            if(!isLoaded) return;
            let base = 0; let cap = 2000; let forceGrid = false;
            state.slots.forEach((s, idx) => { if(s.type === 'AltÄ±n Madeni' && s.status === 'complete') base += s.level * 5; if(s.type === 'Hazine OdasÄ±' && s.status === 'complete') cap = s.level * 5000; if(s.status === 'building') { s.timer--; forceGrid = true; if(activeSlotIndex === idx && document.getElementById('modal-timer')) document.getElementById('modal-timer').innerText = s.timer + "s"; if(s.timer <= 0) { s.status = 'complete'; s.level++; addLog(s.type + " bitti."); if(activeSlotIndex === idx) handleSlot(idx); } } });
            if(state.activeExpedition) { state.activeExpedition.timer--; forceGrid = true; if(activeSlotIndex !== -1 && document.getElementById('modal-timer')) document.getElementById('modal-timer').innerText = state.activeExpedition.timer + "s"; if(state.activeExpedition.timer <= 0) { state.hPoints += state.activeExpedition.reward; addLog("Seferden ganimet alÄ±ndÄ±."); state.activeExpedition = null; if(activeSlotIndex !== -1) handleSlot(activeSlotIndex); } }
            if(state.activeConversion) { state.activeConversion.timer--; forceGrid = true; if(activeSlotIndex !== -1 && document.getElementById('modal-timer')) document.getElementById('modal-timer').innerText = state.activeConversion.timer + "s"; if(state.activeConversion.timer <= 0) { state.hPower += state.activeConversion.pts; addLog("EÄŸitim bitti!"); state.activeConversion = null; if(activeSlotIndex !== -1) handleSlot(activeSlotIndex); } }
            if(state.activeRaid) { state.activeRaid.timer--; if(document.getElementById('modal-timer')) document.getElementById('modal-timer').innerText = Math.max(0, state.activeRaid.timer) + "s"; if(state.activeRaid.timer <= 0) executeRaidResult(); }
            for(let n in state.npcCD) { if(state.npcCD[n] > 0) { state.npcCD[n]--; const btn = document.querySelector(`button[data-npc="${n}"]`); if(btn) btn.innerText = `Bekleniyor (${state.npcCD[n]}s)`; if(state.npcCD[n] <= 0 && btn) { const i = state.slots.findIndex(s=>s.type==='GÃ¶zcÃ¼ Kulesi'); if(i !== -1) openWatchtowerUI(state.slots[i].level, i); } } }
            let inc = base * (1 + (state.techs.mining * 0.1)); if(state.gold < cap) state.gold = Math.min(cap, state.gold + inc);
            updateUI(); if(forceGrid) renderCity(); updateModalButtons();
        }

        function upgrade(i, c) { state.gold -= c; state.slots[i].status = 'building'; state.slots[i].timer = 5; handleSlot(i); renderCity(); }
        function startBuild(i, n) { state.gold -= BUILDINGS[n].cost; state.slots[i] = { type: n, level: 0, status: 'building', timer: 5 }; }
        function attackNPC(npc) { if(state.hPower >= npc.power) { state.hPoints += npc.reward; state.npcCD[npc.name] = 10; addLog(npc.name + " avlandÄ±!"); const i = state.slots.findIndex(s=>s.type==='GÃ¶zcÃ¼ Kulesi'); if(i !== -1) openWatchtowerUI(state.slots[i].level, i); syncCloud(); } else { addLog("GÃ¼cÃ¼n yetersiz!"); } }
        function demolish(i) { state.slots[i] = { type: 'BoÅŸ Slot', level: 0, status: 'empty', timer: 0 }; }
        function research(type) { let cost = (state.techs[type] + 1) * 200; if(state.gold >= cost) { state.gold -= cost; state.techs[type]++; addLog("AraÅŸtÄ±rma bitti."); openUniversityUI(); } }
        function addCloseButton(m) { const b = document.createElement('button'); b.innerText = "Kapat"; b.style.background = "#444"; b.style.color="white"; b.style.marginTop="15px"; b.onclick = closeModal; m.appendChild(b); }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; activeSlotIndex = -1; }
        function startExpedition(s, p) { state.activeExpedition = { timer: s, reward: p }; addLog("AvcÄ±lar yola Ã§Ä±ktÄ±."); }
        function cancelExpedition() { state.activeExpedition = null; addLog("Ä°ptal edildi."); renderCity(); if(activeSlotIndex !== -1) handleSlot(activeSlotIndex); }
        function startConversion(v) { if(v > 0) { state.activeConversion = { timer: 2, pts: v }; state.hPoints -= v; addLog("EÄŸitim baÅŸladÄ±."); } }
        function updateUI() { document.getElementById('gold').innerText = Math.floor(state.gold); document.getElementById('h-points').innerText = Math.floor(state.hPoints); document.getElementById('h-power').innerText = Math.floor(state.hPower); const cap = state.slots.find(s=>s.type==='Hazine OdasÄ±')?.level * 5000 || 2000; document.getElementById('max-gold').innerText = cap; document.getElementById('cap-bar').style.width = (state.gold / cap * 100) + "%"; }
        function showView(v) { document.getElementById('city-view').classList.toggle('hidden', v !== 'city'); document.getElementById('world-view').classList.toggle('hidden', v !== 'world'); if(v==='world') renderMap(); }
        function updateModalButtons() { const o = document.getElementById('modal-overlay'); if(o.style.display === 'flex') { const b = o.querySelectorAll('button[data-cost]'); b.forEach(btn => btn.disabled = state.gold < parseInt(btn.getAttribute('data-cost'))); } }
        function addLog(msg) { const c = document.getElementById('noti-content'); if(!c) return; const i = document.createElement('div'); i.className = 'noti-item'; i.innerHTML = `<small>[${new Date().toLocaleTimeString()}]</small> ${msg}`; c.prepend(i); document.getElementById('noti-dot').style.display = 'block'; }
        function toggleNotifications() { document.getElementById('noti-panel').classList.toggle('open'); document.getElementById('noti-dot').style.display = 'none'; }
        init();
    </script>
</body>
</html>